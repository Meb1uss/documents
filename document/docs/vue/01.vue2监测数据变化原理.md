# vue2 监测数据原理

## `Object.defineProperty`

```

```

## vue2 监测对象

1. 对 data 中的数据进行加工
   - 给 data 中的数据提供 getter/setter
   - 修改 data 中的数据时，调用相应的 `setter`
   - `setter` 调用重新解析模板的函数，刷新页面
2. vm.\_data = data

模拟 vue2 检测数据

```js
let data = {
  msg: "HELLO",
};

// 以对象为参数的构造函数
function Observer(obj) {
  //将对象的所有属性名组成一个数组
  const keys = Object.keys(obj);

  keys.forEach((k) => {
    Object.defineProperty(this, k, {
      // 构造函数中的 this 指向实例对象
      // 给实例对象添加 obj 中所有的属性
      get() {
        return obj[k];
        // 访问实例对象属性时，返回 obj 中相应的属性
      },
      set(val) {
        obj[k] = val;
        // 修改实例对象属性时，同时修改 obj 中相应的属性
        console.log("我需要重新解析模板");
      },
    });
  });
}

const obs = new Observer(data); // data 作为参数

console.log(obs);
```

## Vue.set()

上面的代码有个小问题，如果后续要在 `data` 中添加属性，如

```js
data.message = "hi";
```

此时 `obs` 就无法响应式的添加，更新数据。vue2 中也是如此

```html
<body>
  <div id="app">
    <button @click="addProperty">click me!</button>
    <h2>{{ message.msg1 }}</h2>
    <h2>{{ message.msg2 }}</h2>
  </div>
</body>

<script>
  var vm = new Vue({
    el: "#app",
    data: {
      message: {
        msg1: "Hello",
      },
    },
    methods: {
      addProperty() {
        this.data.message.msg2 = "HI";
      },
    },
  });
</script>
```

并不会在屏幕上展示 `msg2`,使用 `Vue.set()`

```html
<body>
  <div id="app">
    <button @click="addProperty">click me!</button>
    <h2>{{ message.msg1 }}</h2>
    <h2>{{ message.msg2 }}</h2>
  </div>
</body>

<script>
  var vm = new Vue({
    el: "#app",
    data: {
      message: {
        msg1: "Hello",
      },
    },
    methods: {
      addProperty() {
        Vue.set(this.message, "msg2", "HI");
      },
    },
  });
</script>
```

`Vue.set()` 接收三个参数，第一个参数为在哪添加属性，第二、三个参数分别为添加属性的键和值
遗憾的是，`Vue.set` 无法直接给 `data` 中添加属性，只能给 `data` 中的对象添加属性

## Vue 监测数组

Vue2 中数组的索引是没有对应的 setter/getter 的，这意味着通过索引来修改数组，并不会响应式的更新视图。
正确的方式是使用会改变原数组的方法，如 `push、pop、shift、unshift、splice、reverse、sort`。
当然使用 `Vue.set()` 也可以改变
